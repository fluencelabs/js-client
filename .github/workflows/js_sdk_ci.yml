name: Run tests

defaults:
    run:
        working-directory: .

on:
    push:

jobs:
    build:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [16.x, 17.x]

        steps:
            - uses: actions/checkout@v2

            - uses: pnpm/action-setup@v2.2.2
              with:
                  version: 7

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v1
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'pnpm'

            - name: Run container with Fluence node
              run: |
                  docker pull fluencelabs/fluence
                  docker run -d --rm -e RUST_LOG="info" -p 1210:1210 -p 4310:4310 fluencelabs/fluence -t 1210 -w 4310 -k gKdiCSUr1TFGFEgu2t8Ch1XEUsrN5A2UfBLjSZvfci9SPR3NvZpACfcpPGC3eY4zma1pk7UvYv5zb1VjvPHwCjj --local --aqua-pool-size 2

            - name: Install deps
              run: pnpm i
            
            - name: Run tests
              run: pnpm -r test
              env:
                  CI: true
