name: Run tests

defaults:
    run:
        working-directory: .

on:
    push:

jobs:
    build:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [16.x, 17.x]

        steps:
            - uses: actions/checkout@v2

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v1
              with:
                  node-version: ${{ matrix.node-version }}

            - name: Setup pnpm
              uses: pnpm/action-setup@v2.2.4
              with:
                version: 7

            - name: Run container with Fluence node
              run: |
                  docker pull fluencelabs/fluence
                  docker run -d --rm -e RUST_LOG="info" -p 1210:1210 -p 4310:4310 fluencelabs/fluence -t 1210 -w 4310 -k gKdiCSUr1TFGFEgu2t8Ch1XEUsrN5A2UfBLjSZvfci9SPR3NvZpACfcpPGC3eY4zma1pk7UvYv5zb1VjvPHwCjj --local --aqua-pool-size 2

            - run: pnpm i
            - run: pnpm -r build
              env:
                  CI: true
            - run: pnpm -r test
              env:
                  CI: true
